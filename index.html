<!--
NASA 천문명리 시스템 (Sky Chronos)
Data: NASA JPL DE440s + SPICE
-->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NASA 천문명리 시스템 (Sky Chronos)</title>
<meta name="description" content="NASA JPL DE440s 천체력과 SPICE 엔진으로 절기·월지·시주를 계산하는 동양 역법 시스템"/>
<script src="asm_full.js"></script>

<script>
/**
 * Sky Chronos — SPICE JS wrapper for Emscripten asm.js builds
 * Exposes: window.spice.kclear(), furnsh(pathOrUrl), utc2et(utcString), spkpos(...)
 *
 * Requirements:
 * - asm_full.js must define global `Module`
 * - CSPICE symbols exported: kclear_c, furnsh_c, str2et_c, spkpos_c
 */

(function initSpiceWrapper(){
  function fail(msg){
    console.error(msg);
    alert(msg);
  }

  function makeSpice(Module){
    // --- helpers ---
    const malloc = Module._malloc.bind(Module);
    const free   = Module._free.bind(Module);
    const HEAPF64 = Module.HEAPF64;

    function allocCString(str){
      const n = Module.lengthBytesUTF8(str) + 1;
      const p = malloc(n);
      Module.stringToUTF8(str, p, n);
      return p;
    }

    function readF64(ptr, count){
      const base = ptr >> 3; // /8
      const out = [];
      for (let i=0;i<count;i++) out.push(HEAPF64[base + i]);
      return out;
    }

    // --- bind CSPICE functions ---
    const kclear_c = Module.cwrap("kclear_c", null, []);
    const furnsh_c = Module.cwrap("furnsh_c", null, ["number"]);
    const str2et_c = Module.cwrap("str2et_c", null, ["number","number"]);
    const spkpos_c = Module.cwrap("spkpos_c", null, ["number","number","number","number","number","number","number"]);

    // Basic sanity checks (if symbol missing, cwrap may throw or be undefined)
    if (!kclear_c || !furnsh_c || !str2et_c || !spkpos_c){
      throw new Error("CSPICE exported symbols missing. Need: kclear_c, furnsh_c, str2et_c, spkpos_c");
    }

    return {
      // Clear loaded kernels
      kclear(){
        kclear_c();
      },

      // Load kernel file (local path in repo OR remote URL if CORS allows)
      furnsh(pathOrUrl){
        const p = allocCString(pathOrUrl);
        try { furnsh_c(p); }
        finally { free(p); }
      },

      // Convert UTC string -> ET seconds past J2000 (SPICE)
      utc2et(utc){
        const s = allocCString(utc);
        const etPtr = malloc(8);
        try{
          str2et_c(s, etPtr);
          return readF64(etPtr,1)[0];
        } finally {
          free(etPtr);
          free(s);
        }
      },

      // spkpos wrapper
      // returns: [[x,y,z], lt]
      spkpos(targ, et, ref, abcorr, obs){
        const targP = allocCString(targ);
        const refP  = allocCString(ref);
        const abP   = allocCString(abcorr);
        const obsP  = allocCString(obs);

        const posPtr = malloc(3 * 8);
        const ltPtr  = malloc(8);

        try{
          spkpos_c(targP, et, refP, abP, obsP, posPtr, ltPtr);
          const pos = readF64(posPtr,3);
          const lt  = readF64(ltPtr,1)[0];
          return [pos, lt];
        } finally {
          free(ltPtr); free(posPtr);
          free(obsP); free(abP); free(refP); free(targP);
        }
      }
    };
  }

  // Wait until Module exists
  if (typeof window.Module === "undefined"){
    fail("asm_full.js는 로드됐지만 전역 Module을 찾지 못했습니다. <script src='asm_full.js'>가 index.html에 포함되어 있는지 확인하세요.");
    return;
  }

  // Hook runtime init (Emscripten)
  const prev = window.Module.onRuntimeInitialized;
  window.Module.onRuntimeInitialized = function(){
    try{
      if (typeof prev === "function") prev();
      window.spice = makeSpice(window.Module);
      console.log("[Sky Chronos] window.spice ready");
      // 버튼 활성화 같은 후속 처리 원하면 여기서
      // document.getElementById("calcBtn")?.removeAttribute("disabled");
    }catch(e){
      console.error(e);
      fail("SPICE 래퍼 초기화 실패: " + (e && e.message ? e.message : e));
    }
  };

  // 일부 빌드는 onRuntimeInitialized가 이미 지난 상태일 수 있음 → 즉시 시도
  try{
    if (window.Module.calledRun) {
      window.spice = makeSpice(window.Module);
      console.log("[Sky Chronos] window.spice ready (late attach)");
    }
  }catch(_){}
})();
</script>
  
<style>
body{margin:0;background:#0b1020;color:#e9ecf6;font-family:system-ui;padding:16px;padding-bottom:120px}
.card{background:#101833;border-radius:16px;padding:14px;margin-bottom:12px}
button{width:100%;padding:14px;border-radius:12px;border:none;font-weight:900;background:#6ea8ff;color:#000}
</style>
</head>

<body>
<h1>NASA 천문명리 시스템 (Sky Chronos)</h1>

<div class="card">
<label>날짜</label>
<input id="date" type="date">
<label>시각</label>
<input id="time" type="time">
<button onclick="calc()">NASA 기준 계산</button>
</div>

<div class="card">
<h3>결과</h3>
<div id="out">—</div>
</div>

<div class="card">
<h3>GPT용 출력</h3>
<pre id="raw"></pre>
<button onclick="copy()">GPT로 복사</button>
</div>

<script>
function pad(n){return String(n).padStart(2,'0');}
function toUTC(d,t){
  const [Y,M,D]=d.split('-').map(Number);
  const [h,m]=t.split(':').map(Number);
  return new Date(Date.UTC(Y,M-1,D,h-9,m,0)).toISOString().replace('.000Z','');
}

const terms=["춘분","청명","곡우","입하","소만","망종","하지","소서","대서","입추","처서","백로","추분","한로","상강","입동","소설","대설","동지","소한","대한","입춘","우수","경칩"];
const branches=["자","축","인","묘","진","사","오","미","신","유","술","해"];

function calc(){

  alert("SPICE loaded: " + typeof spice);
  
  spice.kclear();
  spice.furnsh("naif0012.tls");
  spice.furnsh("pck00010.tpc");
  spice.furnsh("https://cdn.jsdelivr.net/gh/sky-chronos/nasa-kernels@main/de440s.bsp");

  const d=document.getElementById("date").value;
  const t=document.getElementById("time").value;
  const utc=toUTC(d,t);
  const et=spice.utc2et(utc);

  const pos=spice.spkpos("SUN",et,"ECLIPDATE","LT+S","EARTH");
  const x=pos[0][0],y=pos[0][1];
  let lon=Math.atan2(y,x)*180/Math.PI;
  if(lon<0)lon+=360;

  const termIndex=Math.floor(lon/15);
  const term=terms[termIndex%24];
  const month=branches[(Math.floor((lon-315+360)%360/30)+2)%12];
  const hour=branches[Math.floor(new Date(d+"T"+t).getHours()/2)%12];

  const txt=`절기: ${term}\n월지: ${month}\n시주: ${hour}\n태양황경: ${lon.toFixed(6)}°`;
  document.getElementById("out").innerText=txt;
  document.getElementById("raw").innerText=
`[ASTRONOMICAL BASIS]
UTC: ${utc}
Solar longitude: ${lon.toFixed(9)}
Solar-term: ${term}
Month branch: ${month}
Hour branch: ${hour}`;
}

function copy(){
  navigator.clipboard.writeText(document.getElementById("raw").innerText);
  alert("복사됨");
}
</script>
</body>
</html>


