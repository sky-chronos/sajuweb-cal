<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sky Chronos v4 â€” NASA íƒœì–‘í™©ê²½ ê¸°ë°˜ ì ˆê¸°Â·ë§Œì„¸ë ¥ ê³„ì‚°ê¸°</title>
  <style>
    :root{
      --bg:#0b1020; --card:#101833; --muted:#b9c2e2; --text:#e9ecf6; --line:#223055;
      --btn:#1b2a55; --btn2:#233a75; --good:#19c37d; --warn:#ffcc66; --bad:#ff6b6b;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif; padding:16px; padding-bottom:120px;}
    h1{font-size:18px;margin:6px 0 14px 0;letter-spacing:-0.2px}
    .sub{color:var(--muted);font-size:12px;line-height:1.4}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input,select{width:100%; box-sizing:border-box; padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.10); background:#0c1430;color:var(--text); font-size:14px}
    button{background:var(--btn);color:var(--text);border:1px solid rgba(255,255,255,0.10);border-radius:14px;padding:10px 12px;font-size:14px;cursor:pointer}
    button:hover{background:var(--btn2)}
    .grid{display:grid;grid-template-columns:1fr;gap:8px}
    .kv{display:flex;justify-content:space-between;gap:10px;border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:10px 12px;background:rgba(0,0,0,0.10)}
    .k{color:var(--muted);font-size:12px;min-width:120px}
    .v{font-size:14px;text-align:right;white-space:pre-wrap}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px;border:1px solid rgba(255,255,255,0.10)}
    .b-good{background:rgba(25,195,125,0.15); color:#bff3dc; border-color:rgba(25,195,125,0.35)}
    .b-warn{background:rgba(255,204,102,0.12); color:#ffe1a8; border-color:rgba(255,204,102,0.35)}
    .b-bad{background:rgba(255,107,107,0.12); color:#ffd0d0; border-color:rgba(255,107,107,0.35)}
    pre{white-space:pre-wrap;word-break:break-word;background:#070b18;border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:12px;margin:10px 0 0 0;font-size:12px;line-height:1.5}
    .help{font-size:12px;color:var(--muted);line-height:1.55}
    .mini{font-size:11px;color:var(--muted)}
    .sticky{position:fixed;left:0;right:0;bottom:0;padding:10px 16px;background:rgba(11,16,32,0.92);backdrop-filter: blur(10px);border-top:1px solid rgba(255,255,255,0.08)}
    .sticky .row{justify-content:space-between;align-items:center}
    .sticky .mini{margin:0}
    .row > .col{flex:1;min-width:160px}
    .row > .col.smallcol{min-width:140px}
  </style>
</head>
<body>
  <h1>Sky Chronos v4 <span class="badge">íƒœì–‘í™©ê²½ ê¸°ë°˜ ì ˆê¸°Â·ë§Œì„¸ë ¥ ê³„ì‚°</span></h1>
  <div class="sub">
    âœ… ëª©í‘œ: â€œì´ê±´ ì ì´ ì•„ë‹ˆë¼ ê³„ì‚°â€ â€” íƒœì–‘ì˜ ê²‰ë³´ê¸° í™©ê²½(Î»)ìœ¼ë¡œ ì ˆê¸°Â·ì ˆê¸°ì›”Â·4ì£¼(ì—°ì›”ì¼ì‹œ)ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤.<br/>
    âš ï¸ ì´ í˜ì´ì§€ëŠ” ì—°êµ¬/ê²€ì¦ìš© ê³„ì‚°ê¸°ì´ë©°, í•´ì„ì€ ë³„ë„(ì˜ˆ: GPT)ì— ë¶™ì—¬ë„£ì–´ ì§„í–‰í•˜ì„¸ìš”.
  </div>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>ë‚ ì§œ (KST)</label>
        <input id="date" type="date" value="2026-01-09" />
      </div>
      <div class="col smallcol">
        <label>ì‹œê° (KST)</label>
        <input id="time" type="time" value="21:39" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col">
        <label>ê³„ì‚° ëª¨ë“œ</label>
        <select id="mode">
          <option value="apparent" selected>ê²‰ë³´ê¸° íƒœì–‘(ì§„í™©ê²½ + ì´ì‹¬/ê²½ì‚¬ + ê·¼ì‚¬ì  ì„¸ì°¨/ì¥ë™/ê´‘í–‰ì°¨)</option>
          <option value="true">ì§„íƒœì–‘(ë°©ì •ì‹ ì¤‘ì‹¬í•­ ì ìš©)</option>
        </select>
      </div>
      <div class="col smallcol">
        <label>ì¼ì£¼ ê¸°ì¤€(ì„ íƒ)</label>
        <select id="dayRule">
          <option value="civil" selected>0ì‹œ ê¸°ì¤€(ì¼ë°˜)</option>
          <option value="midnight23">ìì •êµì(23ì‹œ ì´í›„ ë‹¤ìŒë‚ )</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col">
        <label>ì¶œìƒì§€(ê²½ë„ Â°E) â€” ì„ íƒ</label>
        <input id="lonE" type="number" step="0.0001" value="126.9780" />
      </div>
      <div class="col">
        <label>ì°¸ê³ </label>
        <div class="help">
          ì„œìš¸ 126.9780 / ì œì£¼ 126.5312. (í˜„ì¬ v4ëŠ” ì ˆê¸°Â·ë§Œì„¸ë ¥ â€˜í‘œì¤€ ì •ì˜(ì ˆê¸°+ìì •êµì ì˜µì…˜)â€™ ì¤‘ì‹¬ì´ë©°, ê²½ë„ê°’ì€ ë¡œê·¸ì— í•¨ê»˜ ê¸°ë¡í•©ë‹ˆë‹¤.)
        </div>
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <button id="calcBtn" onclick="calc()">NASA ê¸°ì¤€ ê³„ì‚°</button>
      <button onclick="toggleHelp()">ë„ì›€ë§</button>
    </div>

    <div id="helpBox" class="card" style="display:none; margin-top:12px">
      <div class="help">
        <b>ê²½ê³„(ì ˆê¸°Â·ì¼ì£¼) ì•ˆë‚´</b><br/>
        â€¢ ì ˆê¸° ê²½ê³„ ê·¼ì²˜(ì˜ˆ: Â±2ì‹œê°„)ëŠ” ì¼ë¶€ ë§Œì„¸ë ¥/ì•±ì˜ ì •ì˜ ì°¨ì´ë¡œ ê²°ê³¼ê°€ ê°ˆë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
        â€¢ <b>ìì •êµì</b>: 23:00~23:59ë¥¼ â€œë‹¤ìŒë‚ (ì¼ì£¼)â€ë¡œ ë³´ëŠ” ì „í†µ í˜¸í™˜ ì˜µì…˜ì…ë‹ˆë‹¤.<br/>
        â€¢ ì‹ ë¢° ë“±ê¸‰(ê¶Œì¥): |ê²½ê³„ê¹Œì§€ ì‹œê°„| â‰¥ 12ì‹œê°„ â†’ ë†’ìŒ / 2~12ì‹œê°„ â†’ ì£¼ì˜ / &lt;2ì‹œê°„ â†’ ê²½ê³„(ì–‘ë©´ í•´ì„ ê¶Œì¥).<br/><br/>
        <b>í•œê³„ ê³ ì§€(í•„ìˆ˜)</b><br/>
        â€¢ ì´ í˜ì´ì§€ëŠ” <b>ê³„ì‚°ê¸°</b>ì´ë©°, í•´ì„ì€ ë³„ë„ë¡œ í•˜ì„¸ìš”.<br/>
        â€¢ ì¼ë¶€ í•´ì„(ê²©êµ­/ìš©ì‹ /ëŒ€ìš´ ë“±)ì€ ì „í†µ ì²´ê³„Â·ì •ì˜ì— ë”°ë¼ ì¶”ê°€ ë°ì´í„°/ê°€ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div class="kv"><div class="k">ì…ë ¥(í•œêµ­ì‹œê°„)</div><div class="v" id="out_kst">â€”</div></div>
      <div class="kv"><div class="k">ì„¸ê³„ì‹œ(UTC)</div><div class="v" id="out_utc">â€”</div></div>
      <div class="kv"><div class="k">ê³„ì‚° ëª¨ë“œ</div><div class="v" id="out_mode">â€”</div></div>

      <div class="kv"><div class="k">íƒœì–‘ í™©ê²½(Î»)</div><div class="v" id="out_lon">â€”</div></div>
      <div class="kv"><div class="k">ì ˆê¸°</div><div class="v" id="out_term">â€”</div></div>
      <div class="kv"><div class="k">ì ˆê¸° ê²½ê³„</div><div class="v" id="out_boundary">â€”</div></div>
      <div class="kv"><div class="k">ê°€ì¥ ê°€ê¹Œìš´ ê²½ê³„</div><div class="v" id="out_near">â€”</div></div>
      <div class="kv"><div class="k">ê²½ê³„ê¹Œì§€ ì‹œê°„ ì°¨</div><div class="v" id="out_delta">â€”</div></div>
      <div class="kv"><div class="k">ì‹ ë¢° ë“±ê¸‰</div><div class="v" id="out_quality">â€”</div></div>

      <div class="kv"><div class="k">ì ˆê¸°ì›”(ì›”ì§€)</div><div class="v" id="out_monthB">â€”</div></div>
      <div class="kv"><div class="k">ì‹œì§€</div><div class="v" id="out_hourB">â€”</div></div>

      <div class="kv"><div class="k">ì—°ì£¼(å¹´æŸ±)</div><div class="v" id="out_yearP">â€”</div></div>
      <div class="kv"><div class="k">ì›”ì£¼(æœˆæŸ±)</div><div class="v" id="out_monthP">â€”</div></div>
      <div class="kv"><div class="k">ì¼ì£¼(æ—¥æŸ±)</div><div class="v" id="out_dayP">â€”</div></div>
      <div class="kv"><div class="k">ì‹œì£¼(æ™‚æŸ±)</div><div class="v" id="out_hourP">â€”</div></div>

      <div class="kv"><div class="k">ì‚¬ì£¼ 4ì£¼(ì—°Â·ì›”Â·ì¼Â·ì‹œ)</div><div class="v" id="pillars">â€”</div></div>
    </div>

    <h3 style="margin:12px 0 6px 2px;font-size:14px">GPTìš© ì¶œë ¥</h3>
    <div class="row">
      <button onclick="copyGPT()">ğŸ“‹ ê²°ê³¼ ë³µì‚¬</button>
      <button onclick="openGPT()">ğŸ¤– GPTì—ì„œ í•´ì„</button>
    </div>
    <pre id="raw">â€”</pre>
  </div>

  <div class="sticky">
    <div class="row">
      <div class="mini">Â© Sky Chronos â€” ê³„ì‚°ê°’ì€ ì—°êµ¬/ê²€ì¦ìš©. â€œìš´ëª… ë‹¨ì •â€ì´ ì•„ë‹Œ êµ¬ì¡° ë¶„ì„ ìë£Œì…ë‹ˆë‹¤.</div>
      <div class="mini" id="ver">v4</div>
    </div>
  </div>

<script>
/* ===================== ê¸°ë³¸ í…Œì´ë¸” ===================== */
const stems = ["ê°‘","ì„","ë³‘","ì •","ë¬´","ê¸°","ê²½","ì‹ ","ì„","ê³„"];
const branches = ["ì","ì¶•","ì¸","ë¬˜","ì§„","ì‚¬","ì˜¤","ë¯¸","ì‹ ","ìœ ","ìˆ ","í•´"];
const hanjaStems = ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"];
const hanjaBranches = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];

// 24ì ˆê¸°: ì‹œì‘ì ì„ ì…ì¶˜(315Â°)ë¡œ ë‘ê³  15Â° ê°„ê²©
const terms = [
  "ì…ì¶˜","ìš°ìˆ˜","ê²½ì¹©","ì¶˜ë¶„","ì²­ëª…","ê³¡ìš°",
  "ì…í•˜","ì†Œë§Œ","ë§ì¢…","í•˜ì§€","ì†Œì„œ","ëŒ€ì„œ",
  "ì…ì¶”","ì²˜ì„œ","ë°±ë¡œ","ì¶”ë¶„","í•œë¡œ","ìƒê°•",
  "ì…ë™","ì†Œì„¤","ëŒ€ì„¤","ë™ì§€","ì†Œí•œ","ëŒ€í•œ"
];

const monthBranchOrder = ["ì¸","ë¬˜","ì§„","ì‚¬","ì˜¤","ë¯¸","ì‹ ","ìœ ","ìˆ ","í•´","ì","ì¶•"]; // ì…ì¶˜=ì¸ì›” ì‹œì‘

/* ===================== ìœ í‹¸ ===================== */
function pad2(n){ return String(n).padStart(2,"0"); }
function clamp360(x){ x%=360; if(x<0) x+=360; return x; }
function deg2rad(d){ return d*Math.PI/180; }
function rad2deg(r){ return r*180/Math.PI; }

function toggleHelp(){
  const b = document.getElementById("helpBox");
  b.style.display = (b.style.display==="none") ? "block" : "none";
}

/* ===================== JD/ì‹œê°„ ë³€í™˜ ===================== */
function dateTimeKSTToUTCISO(dateStr, timeStr){
  // dateStr: YYYY-MM-DD, timeStr: HH:MM
  const [Y,M,D] = dateStr.split("-").map(Number);
  const [h,m] = timeStr.split(":").map(Number);
  // KST = UTC+9
  const utc = new Date(Date.UTC(Y, M-1, D, h-9, m, 0));
  const iso = `${utc.getUTCFullYear()}-${pad2(utc.getUTCMonth()+1)}-${pad2(utc.getUTCDate())} ${pad2(utc.getUTCHours())}:${pad2(utc.getUTCMinutes())}`;
  return { utcDate: utc, utcIso: iso };
}

function julianDayFromDateUTC(d){
  // d: Date (UTC-based)
  return d.getTime()/86400000 + 2440587.5;
}

// â€œíš¨ë ¥ì¼(ì¼ì£¼ ê³„ì‚°ìš© ë‚ ì§œ)â€ì„ ë§Œë“¤ê¸°: JDNì„ ì•ˆì •ì ìœ¼ë¡œ ë½‘ê¸° ìœ„í•´ KST ì •ì˜¤(12:00)ë¥¼ ì‚¬ìš©
function effectiveDateForDayPillar(dateStr, timeStr, dayRule){
  const [Y,M,D] = dateStr.split("-").map(Number);
  const [h,mm] = timeStr.split(":").map(Number);

  // ê¸°ë³¸ì€ ì…ë ¥ ë‚ ì§œ ê·¸ëŒ€ë¡œ
  let eff = new Date(Date.UTC(Y, M-1, D, 3, 0, 0)); // 12:00 KST = 03:00 UTC

  if(dayRule === "midnight23"){
    // â€œ23ì‹œ ì´í›„ ë‹¤ìŒë‚ â€ â†’ ì…ë ¥ ì‹œê°„ì´ 23:00~23:59ë©´ íš¨ë ¥ì¼ì„ +1
    if(h >= 23){
      eff = new Date(eff.getTime() + 86400000);
    }
  }
  // civil(0ì‹œ ê¸°ì¤€)ì€ ë‚ ì§œ ê·¸ëŒ€ë¡œ
  return eff; // UTC Date at 03:00
}

/* ===================== íƒœì–‘ í™©ê²½(ê·¼ì‚¬) ===================== */
/*
  NOAA ê³„ì—´ ê·¼ì‚¬ì‹(ì¼ë°˜ì ì¸ íƒœì–‘ ê²‰ë³´ê¸° í™©ê²½):
  - T: Julian centuries from J2000.0
  - L0: mean longitude
  - M: mean anomaly
  - C: equation of center
  - trueLong = L0 + C
  - apparentLong = trueLong - 0.00569 - 0.00478*sin(omega)
*/
function solarLongitudeApprox(jd, mode){
  const T = (jd - 2451545.0)/36525.0;

  let L0 = 280.46646 + 36000.76983*T + 0.0003032*T*T;
  L0 = clamp360(L0);

  let M = 357.52911 + 35999.05029*T - 0.0001537*T*T;
  M = clamp360(M);

  const Mr = deg2rad(M);
  const C = (1.914602 - 0.004817*T - 0.000014*T*T)*Math.sin(Mr)
          + (0.019993 - 0.000101*T)*Math.sin(2*Mr)
          + 0.000289*Math.sin(3*Mr);

  let trueLong = L0 + C;
  trueLong = clamp360(trueLong);

  // omega: longitude of ascending node of Moon's mean orbit
  const omega = 125.04 - 1934.136*T;
  const apparentLong = clamp360(trueLong - 0.00569 - 0.00478*Math.sin(deg2rad(omega)));

  return {
    T, L0, M, C,
    trueLong,
    apparentLong: apparentLong,
    lon: (mode==="true") ? trueLong : apparentLong
  };
}

/* ===================== ì ˆê¸°/ì›”ì§€ ê³„ì‚° ===================== */
function termIndexFromLon(lon){
  // ì…ì¶˜ ì‹œì‘ì„ 315Â°ë¡œ ë‘ê³  15Â° ê°„ê²©
  const x = clamp360(lon - 315);
  return Math.floor(x / 15); // 0..23
}

function termStartLon(idx){
  return clamp360(315 + idx*15);
}
function termEndLon(idx){
  return clamp360(315 + (idx+1)*15);
}

function monthBranchFromTermIndex(idx){
  // ì ˆê¸°ì›”ì€ â€œì ˆê¸° 2ê°œ(30Â°)ë‹¹ 1ê°œì›”â€ë¡œë„ ì“°ì§€ë§Œ,
  // ì—¬ê¸°ì„œëŠ” â€œì…ì¶˜~â€ì˜ 12ê°œì›”ì„ 30Â° ë‹¨ìœ„ë¡œ ë§¤í•‘:
  // idx 0~1 â†’ ì¸ì›”, 2~3 â†’ ë¬˜ì›”, ...
  const mi = Math.floor(idx/2); // 0..11
  return monthBranchOrder[mi];
}

/* ===================== ì‹œì§€ ê³„ì‚° ===================== */
function hourBranchFromKST(timeStr){
  const [h,m] = timeStr.split(":").map(Number);
  const minutes = h*60 + m;

  // ìì‹œ: 23:00~00:59
  // ì¶•ì‹œ: 01:00~02:59 ...
  // í•´ì‹œ: 21:00~22:59
  const ranges = [
    {b:"ì", s:23*60, e:24*60+59},
    {b:"ì¶•", s:1*60, e:2*60+59},
    {b:"ì¸", s:3*60, e:4*60+59},
    {b:"ë¬˜", s:5*60, e:6*60+59},
    {b:"ì§„", s:7*60, e:8*60+59},
    {b:"ì‚¬", s:9*60, e:10*60+59},
    {b:"ì˜¤", s:11*60, e:12*60+59},
    {b:"ë¯¸", s:13*60, e:14*60+59},
    {b:"ì‹ ", s:15*60, e:16*60+59},
    {b:"ìœ ", s:17*60, e:18*60+59},
    {b:"ìˆ ", s:19*60, e:20*60+59},
    {b:"í•´", s:21*60, e:22*60+59},
  ];

  // ì²˜ë¦¬: 23:00~23:59ëŠ” ë‹¤ìŒë‚  ë²”ìœ„ë¡œ ê³„ì‚°í•˜ê¸° ìœ„í•´ minutesë¥¼ 24h ì´ìƒìœ¼ë¡œ
  if(minutes >= 23*60){
    const mm = minutes + 24*60;
    return ranges.find(r => mm>=r.s && mm<=r.e).b;
  }
  return ranges.find(r => minutes>=r.s && minutes<=r.e).b;
}

/* ===================== 4ì£¼(ì—°ì›”ì¼ì‹œ) ê³„ì‚° ===================== */

// (A) ì—°ì£¼: ì…ì¶˜(315Â°) ê¸°ì¤€ ì ˆê¸°ë…„
function solarYearByIpchun(lon, dateStr){
  const [Y] = dateStr.split("-").map(Number);
  return (lon >= 315) ? Y : (Y - 1);
}
function yearPillarFromSolarYear(solarYear){
  const baseYear = 1984; // ê°‘ìë…„
  const diff = solarYear - baseYear;
  const si = ((diff % 10) + 10) % 10;
  const bi = ((diff % 12) + 12) % 12;
  return { stemIndex: si, branchIndex: bi, stem: stems[si], branch: branches[bi] };
}

// (B) ì¼ì£¼: â€œì „í†µ ë§Œì„¸ë ¥ê³¼ ì •í•©(ìº˜ë¦¬ë¸Œë ˆì´ì…˜)â€ ì˜¤í”„ì…‹ ê³ ì •
// ê¸°ì¤€ì (ê²€ì¦): 2025-01-09(ë‚® ì‹œê°„) = ë¬´ì¸(æˆŠå¯…) â†’ ì˜¤í”„ì…‹ ë„ì¶œ
// v4 ê³ ì •ê°’:
const DAY_STEM_OFFSET = 9;  // (JDN + 9) % 10
const DAY_BRANCH_OFFSET = 1; // (JDN + 1) % 12

function jdnFromUTCDate(d){
  // JDN = floor(JD + 0.5)
  const jd = julianDayFromDateUTC(d);
  return Math.floor(jd + 0.5);
}

function dayPillarFromEffectiveUTCDate(effUTC){
  const J = jdnFromUTCDate(effUTC);
  const si = (J + DAY_STEM_OFFSET) % 10;
  const bi = (J + DAY_BRANCH_OFFSET) % 12;
  return { stemIndex: si, branchIndex: bi, stem: stems[si], branch: branches[bi] };
}

// (C) ì›”ì£¼: ì—°ê°„ìœ¼ë¡œ å¯…ì›” ì›”ê°„ì„ ì •í•˜ê³ , ì›”ì§€ ìˆœí™˜
function monthStemIndexFromYearStem(yearStemIndex){
  // å¯…ì›” ì›”ê°„ = (ì—°ê°„*2 + 2) % 10
  return (yearStemIndex*2 + 2) % 10;
}
function monthPillarFromYearStemAndMonthBranch(yearStemIndex, monthBranch){
  const mi = monthBranchOrder.indexOf(monthBranch); // ì¸=0 .. ì¶•=11
  const base = monthStemIndexFromYearStem(yearStemIndex);
  const si = (base + mi) % 10;
  const bi = branches.indexOf(monthBranch);
  return { stemIndex: si, branchIndex: bi, stem: stems[si], branch: monthBranch };
}

// (D) ì‹œì£¼: ì¼ê°„ìœ¼ë¡œ å­ì‹œ ì‹œê°„ ê²°ì • í›„ ì‹œì§€ ìˆœí™˜
function hourStemIndexFromDayStem(dayStemIndex){
  // å­ì‹œ ì‹œê°„ = (ì¼ê°„*2) % 10
  return (dayStemIndex*2) % 10;
}
function hourPillarFromDayStemAndHourBranch(dayStemIndex, hourBranch){
  const hi = branches.indexOf(hourBranch); // ì=0..í•´=11
  const base = hourStemIndexFromDayStem(dayStemIndex);
  const si = (base + hi) % 10;
  return { stemIndex: si, branchIndex: hi, stem: stems[si], branch: hourBranch };
}

/* ===================== ê²½ê³„/í’ˆì§ˆ ê³„ì‚° ===================== */
function boundaryDeltaMinutes(lon, idx){
  // ë‹¨ìˆœ ê·¼ì‚¬: íƒœì–‘ í‰ê·  ì´ë™ëŸ‰ 0.985647Â°/day
  const degPerMin = 0.985647 / (24*60);
  const start = termStartLon(idx);
  const end = termStartLon(idx+1);

  // ì´ì „ ê²½ê³„(í•´ë‹¹ ì ˆê¸° ì‹œì‘)ë¡œë¶€í„° ê²½ê³¼ë¶„(+) / ì´ì „ì´ë©´(-)ì´ ì•„ë‹ˆë¼, í˜„ì¬ ì ˆê¸° ë‚´ì—ì„œëŠ” ì–‘ìˆ˜.
  // í•˜ì§€ë§Œ ìš°ë¦¬ëŠ” â€œê°€ì¥ ê°€ê¹Œìš´ ê²½ê³„â€ë¥¼ ì„ íƒí•´ +/- í‘œê¸°.
  const x = clamp360(lon - start); // 0~15
  const toPrev = x / degPerMin;           // ë¶„ (ì ˆê¸° ì‹œì‘ ì´í›„ ê²½ê³¼)
  const toNext = (15 - x) / degPerMin;    // ë¶„ (ë‹¤ìŒ ì ˆê¸°ê¹Œì§€ ë‚¨ì€)

  if(toPrev <= toNext){
    return { near:"ì´ì „ ì ˆê¸° ê²½ê³„ " + terms[idx], deltaMin: Math.round(-toPrev) }; // â€œê²½ê³„ë¡œë¶€í„° ê²½ê³¼â€ë¥¼ ìŒìˆ˜ë¡œ í‘œê¸°(ì´ì „ ê²½ê³„ì—ì„œ ì–¼ë§ˆë‚˜ ì§€ë‚¬ëŠ”ì§€)
  } else {
    return { near:"ë‹¤ìŒ ì ˆê¸° ê²½ê³„ " + terms[(idx+1)%24], deltaMin: Math.round(toNext) };
  }
}

function qualityFromDelta(deltaMin){
  const a = Math.abs(deltaMin);
  if(a >= 720) return {label:"ë†’ìŒ", cls:"b-good", risk:"ì•ˆì •", hint:"ê²½ê³„ ì–‘ë©´ í•´ì„ ë¶ˆí•„ìš”"};
  if(a >= 120) return {label:"ì£¼ì˜", cls:"b-warn", risk:"ê·¼ì ‘", hint:"ê²½ê³„ ì˜í–¥ ê°€ëŠ¥(ë³´ì¡° í•´ì„ ê¶Œì¥)"};
  return {label:"ê²½ê³„", cls:"b-bad", risk:"ê²½ê³„", hint:"ì ˆê¸°/ì›”ì§€ ë¶„ê¸°(ì–‘ë©´ í•´ì„) ê¶Œì¥"};
}

/* ===================== ë²„íŠ¼/ì¶œë ¥ ===================== */
function calc(){
  const dateStr = document.getElementById("date").value;
  const timeStr = document.getElementById("time").value;
  const mode = document.getElementById("mode").value;
  const dayRule = document.getElementById("dayRule").value;
  const lonE = parseFloat(document.getElementById("lonE").value || "126.9780");

  if(!dateStr || !timeStr){
    alert("ë‚ ì§œì™€ ì‹œê°ì„ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  // UTC ë³€í™˜
  const {utcDate, utcIso} = dateTimeKSTToUTCISO(dateStr, timeStr);
  const jd = julianDayFromDateUTC(utcDate);

  // íƒœì–‘ í™©ê²½ ê³„ì‚°
  const sol = solarLongitudeApprox(jd, mode);
  const lon = sol.lon;

  // ì ˆê¸°/ì›”ì§€
  const tIdx = termIndexFromLon(lon);
  const term = terms[tIdx];
  const boundary = `${terms[tIdx]} â†’ ${terms[(tIdx+1)%24]}`;
  const monthB = monthBranchFromTermIndex(tIdx);
  const hourB = hourBranchFromKST(timeStr);

  // ê²½ê³„ ë¸íƒ€/í’ˆì§ˆ
  const b = boundaryDeltaMinutes(lon, tIdx);
  const q = qualityFromDelta(b.deltaMin);

  // 4ì£¼(ì—°ì›”ì¼ì‹œ)
  const solarYear = solarYearByIpchun(lon, dateStr);
  const yP = yearPillarFromSolarYear(solarYear);

  const effUTC = effectiveDateForDayPillar(dateStr, timeStr, dayRule);
  const dP = dayPillarFromEffectiveUTCDate(effUTC);

  const mP = monthPillarFromYearStemAndMonthBranch(yP.stemIndex, monthB);
  const hP = hourPillarFromDayStemAndHourBranch(dP.stemIndex, hourB);

  // í•œì í‘œê¸°
  function hzStem(si){ return hanjaStems[si]; }
  function hzBranch(bi){ return hanjaBranches[bi]; }
  function pillarText(p){ return `${p.stem}${p.branch} (${hzStem(p.stemIndex)}${hzBranch(p.branchIndex)})`; }
  function branchText(b){ 
    const bi = branches.indexOf(b);
    return `${b} (${hanjaBranches[bi]})`;
  }

  // í™”ë©´ ì¶œë ¥
  document.getElementById("out_kst").textContent = `${dateStr} ${timeStr}`;
  document.getElementById("out_utc").textContent = utcIso + " (UTC)";
  document.getElementById("out_mode").textContent = (mode==="true") ? "ì§„íƒœì–‘(ê·¼ì‚¬)" : "ê²‰ë³´ê¸° íƒœì–‘(ê·¼ì‚¬)";

  document.getElementById("out_lon").textContent = `${lon.toFixed(6)}Â°`;
  document.getElementById("out_term").textContent = `${term} (${englishTerm(term)})`;
  document.getElementById("out_boundary").textContent = boundary;

  document.getElementById("out_near").textContent = b.near;
  document.getElementById("out_delta").textContent = `${b.deltaMin}ë¶„ (${deltaExplain(b.deltaMin)})`;
  document.getElementById("out_quality").innerHTML = `${q.label} <span class="badge ${q.cls}">${q.risk}</span><div class="mini">${q.hint}</div>`;

  document.getElementById("out_monthB").textContent = branchText(monthB);
  document.getElementById("out_hourB").textContent = branchText(hourB);

  document.getElementById("out_yearP").textContent = pillarText(yP);
  document.getElementById("out_monthP").textContent = pillarText(mP);
  document.getElementById("out_dayP").textContent = pillarText(dP);
  document.getElementById("out_hourP").textContent = pillarText(hP);

  document.getElementById("pillars").textContent =
    `${yP.stem}${yP.branch} / ${mP.stem}${mP.branch} / ${dP.stem}${dP.branch} / ${hP.stem}${hP.branch}`;

  // GPTìš© ì¶œë ¥(í•œê¸€)
  const effKey = `${effUTC.getUTCFullYear()}-${pad2(effUTC.getUTCMonth()+1)}-${pad2(effUTC.getUTCDate())}`;
  const raw =
`[Sky Chronos v4 â€” íƒœì–‘í™©ê²½ ê¸°ë°˜ ì²œë¬¸Â·ì ˆê¸°Â·ë§Œì„¸ë ¥ ê³„ì‚°]

[SC-PACK v1]
ì…ë ¥_í•œêµ­ì‹œê°„=${dateStr} ${timeStr}
ì„¸ê³„ì‹œ_UTC=${utcIso}
ê³„ì‚°ëª¨ë“œ=${(mode==="true")?"ì§„íƒœì–‘(ê·¼ì‚¬)":"ê²‰ë³´ê¸° íƒœì–‘(ê·¼ì‚¬)"}
íƒœì–‘í™©ê²½_deg=${lon.toFixed(6)}
ì ˆê¸°=${term}
ì ˆê¸°ê²½ê³„=${boundary}
ì ˆê¸°ì›”=${monthB}
ì‹œì§€=${hourB}
ê°€ì¥ê°€ê¹Œìš´ê²½ê³„=${b.near}
ê²½ê³„ê¹Œì§€_ë¶„=${b.deltaMin}
ì‹ ë¢°ë“±ê¸‰=${q.label}
ê²½ê³„ìœ„í—˜=${q.risk}
ì¼ì£¼ê¸°ì¤€=${(dayRule==="civil")?"0ì‹œ ê¸°ì¤€":"ìì •êµì(23ì‹œ ì´í›„ ë‹¤ìŒë‚ )"}
íš¨ë ¥ì¼(ì¼ì£¼ê³„ì‚°ìš©)=${effKey}
ê²½ë„E=${lonE.toFixed(4)}
[/SC-PACK]

[ì²œë¬¸ ê³„ì‚° ìš”ì•½]
ì…ë ¥(í•œêµ­ì‹œê°„): ${dateStr} ${timeStr}
ì„¸ê³„ì‹œ(UTC): ${utcIso}
ê³„ì‚° ëª¨ë“œ: ${(mode==="true")?"ì§„íƒœì–‘(ê·¼ì‚¬)":"ê²‰ë³´ê¸° íƒœì–‘(ê·¼ì‚¬)"}
íƒœì–‘ í™©ê²½: ${lon.toFixed(6)}Â°
ì ˆê¸°: ${term}
ì ˆê¸° ê²½ê³„: ${boundary}
ê°€ì¥ ê°€ê¹Œìš´ ì ˆê¸° ê²½ê³„: ${b.near}
ê²½ê³„ê¹Œì§€ ì‹œê°„ ì°¨: ${b.deltaMin}ë¶„ (${deltaExplain(b.deltaMin)})
ì‹ ë¢° ë“±ê¸‰: ${q.label} (${q.risk}) â€” ${q.hint}

[ë§Œì„¸ë ¥ 4ì£¼(ì—°Â·ì›”Â·ì¼Â·ì‹œ)]
ì—°ì£¼(ì…ì¶˜ ê¸°ì¤€): ${yP.stem}${yP.branch} (${hzStem(yP.stemIndex)}${hzBranch(yP.branchIndex)})
ì›”ì£¼(ì ˆê¸°ì›”): ${mP.stem}${mP.branch} (${hzStem(mP.stemIndex)}${hzBranch(mP.branchIndex)})
ì¼ì£¼(${(dayRule==="civil")?"0ì‹œ ê¸°ì¤€":"ìì •êµì"}): ${dP.stem}${dP.branch} (${hzStem(dP.stemIndex)}${hzBranch(dP.branchIndex)})
ì‹œì£¼: ${hP.stem}${hP.branch} (${hzStem(hP.stemIndex)}${hzBranch(hP.branchIndex)})

[í•œê³„ ê³ ì§€(í•„ìˆ˜)]
ì´ ì¶œë ¥ì€ â€˜ì ˆê¸°(íƒœì–‘í™©ê²½) + ì ˆê¸°ì›” + 4ì£¼ ê³„ì‚°(ì „í†µ ê·œì¹™/ì˜µì…˜ ì ìš©)â€™ì— ê¸°ë°˜í•œ ê³„ì‚° ê²°ê³¼ì…ë‹ˆë‹¤.
í•´ì„(ê²©êµ­/ìš©ì‹ /ëŒ€ìš´/ê¸¸í‰ ë‹¨ì •)ì€ ë³„ë„ì˜ ëª…ë¦¬ ì²´ê³„Â·ì •ì˜Â·ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.
`;
  document.getElementById("raw").textContent = raw;
}

function englishTerm(k){
  // ì•„ì£¼ ì§§ì€ ë³‘ê¸°(ì›í•˜ë©´ ë¹¼ë„ ë¨). â€œê²°ê³¼ì—ì„œ ì˜ì–´ë¥¼ ë‹¤ í•œê¸€ë¡œâ€ ìš”ì²­ì— ë§ì¶° ì‚¬ì‹¤ìƒ ì¥ì‹ ìˆ˜ì¤€.
  // ì™„ì „ ì œê±°í•˜ë ¤ë©´ ì•„ë˜ return ""ë¡œ ë°”ê¿”ë„ ë¨.
  const map = {
    "ì…ì¶˜":"Beginning of Spring","ìš°ìˆ˜":"Rain Water","ê²½ì¹©":"Awakening of Insects","ì¶˜ë¶„":"Vernal Equinox","ì²­ëª…":"Pure Brightness","ê³¡ìš°":"Grain Rain",
    "ì…í•˜":"Beginning of Summer","ì†Œë§Œ":"Grain Full","ë§ì¢…":"Grain in Ear","í•˜ì§€":"Summer Solstice","ì†Œì„œ":"Minor Heat","ëŒ€ì„œ":"Major Heat",
    "ì…ì¶”":"Beginning of Autumn","ì²˜ì„œ":"Limit of Heat","ë°±ë¡œ":"White Dew","ì¶”ë¶„":"Autumnal Equinox","í•œë¡œ":"Cold Dew","ìƒê°•":"Frost's Descent",
    "ì…ë™":"Beginning of Winter","ì†Œì„¤":"Minor Snow","ëŒ€ì„¤":"Major Snow","ë™ì§€":"Winter Solstice","ì†Œí•œ":"Minor Cold","ëŒ€í•œ":"Major Cold"
  };
  return map[k] ? map[k] : "";
}

function deltaExplain(deltaMin){
  if(deltaMin===0) return "ì ˆê¸° ê²½ê³„ì™€ ë™ì¼";
  if(deltaMin<0){
    const h = Math.round(Math.abs(deltaMin)/60);
    return `ê²½ê³„ ì´í›„ ì•½ ${h}ì‹œê°„ ê²½ê³¼`;
  } else {
    const h = Math.round(deltaMin/60);
    return `ê²½ê³„ê¹Œì§€ ì•½ ${h}ì‹œê°„ ë‚¨ìŒ`;
  }
}

function copyGPT(){
  const text = document.getElementById("raw").textContent;
  if(!text || text.trim()==="â€”"){
    alert("ë¨¼ì € â€˜NASA ê¸°ì¤€ ê³„ì‚°â€™ì„ ì‹¤í–‰í•˜ì„¸ìš”.");
    return;
  }
  navigator.clipboard.writeText(text).then(()=>{
    alert("ë³µì‚¬ ì™„ë£Œ! GPTì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.");
  }).catch(()=>{
    alert("ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
  });
}

function openGPT(){
  const text = document.getElementById("raw").textContent;
  if(!text || text.trim()==="â€”"){
    alert("ë¨¼ì € â€˜NASA ê¸°ì¤€ ê³„ì‚°â€™ì„ ì‹¤í–‰í•˜ì„¸ìš”.");
    return;
  }
  navigator.clipboard.writeText(text).catch(()=>{});
  // TODO: ë‹¹ì‹ ì˜ GPT ë§í¬ë¡œ êµì²´
  const url = "https://chat.openai.com/";
  window.open(url, "_blank");
  alert("ê³„ì‚° ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nGPT ì°½ì´ ì—´ë¦¬ë©´ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.");
}

// ì²« ë¡œë“œ ì‹œ í•œë²ˆ ê³„ì‚°
calc();
</script>
</body>
</html>
